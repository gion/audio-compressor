"use strict";window.AudioCompressor=function(){function a(a){var b=a.split(":");return 60*parseFloat(b[0])*60+60*parseFloat(b[1])+parseFloat(b[2])+parseFloat("0."+b[3])}var b=function(a){this.worker=null,this.workerRunning=!1,this.fileName=null,this.fileBuffer=null,this.events={},this.bitRate=128,this.format="mp3",this.workerPath="scripts/worker.js",this._init(a)};return b.prototype={_init:function(a){if(this.fileName=a.fileName,this.fileBuffer=a.fileBuffer,a.format)this.format=a.format;else{var b=this.fileName.replace(/^.*\./,"");b&&(this.format=b.toLowerCase())}return a.bitRate&&(this.bitRate=a.bitRate),a.workerPath&&(this.workerPath=a.workerPath),this.initWorker(),this},_getArguments:function(){var a=[],b=this.fileName.replace(/\..*?$/,"");switch(a.push("-i"),a.push(this.fileName),a.push("-b:a"),a.push(this.bitRate+"k"),this.format){case"mp3":a.push("-acodec"),a.push("libmp3lame"),a.push(b+".mp3");break;case"ogg":a.push("-acodec"),a.push("libvorbis"),a.push(b+".ogg");break;case"aac":a.push("-acodec"),a.push("libfdk_aac"),a.push(b+".mp4");break;case"wma":a.push("-acodec"),a.push("wmav1"),a.push(b+".asf")}return a},_getMimeType:function(){return"audio/"+this.format},convert:function(){this.worker.postMessage({type:"command",arguments:this._getArguments(),files:[{name:this.fileName,buffer:this.fileBuffer}]})},cancel:function(a){this.worker.terminate(),this.trigger("abort",{message:a||"cancelled by the user"})},on:function(a,b){return this.events[a]||(this.events[a]=[]),this.events[a].push(b.bind(this)),this},off:function(a,b){if(1===arguments.length)this.events[a]=[];else{var c=this.events[a].indexOf(b);-1!==c&&this.events[a].splice(c,1)}return this},initWorker:function(){return this.worker&&this.workerRunning&&this.worker.terminate(),this.worker=this._getFFMPEGWorker(),this.workerRunning=!0,this},trigger:function(a,b){return this.events[a]&&this.events[a].forEach(function(c){c({type:a,data:b},b)}),this},_getFFMPEGWorker:function(){var b,c,d=this,e=/Duration: (.*?), /,f=/time=(.*?) /,g=/bitrate:\s?(\d+)\s?kb\/s/,h=new Worker(this.workerPath);return h.addEventListener("message",function(h){var i,j,k=h.data;if(d.trigger(k.type,k),"stderr"===k.type)!b&&e.exec(k.data)&&(b=a(e.exec(k.data)[1])),b&&f.exec(k.data)&&(i=a(f.exec(k.data)[1]),j=Math.floor(i/b*100),d.trigger("progress",j)),!c&&g.test(k.data)&&(c=+g.exec(k.data)[1]),c&&c<=d.bitRate&&d.cancel("audio bitRate ("+c+"kb/s) is actually lower than (ot equal with) our target. No need for a compression.");else if("done"===k.type){var l=k.data.code,m=Object.keys(k.data.outputFiles);if(0===l&&m.length){var n=m[0],o=k.data.outputFiles[n],p=new Blob([o],{type:d._getMimeType()}),q=window.URL.createObjectURL(p),r={name:n,buffer:o,blob:p,url:q};d.trigger("success",r)}else d.trigger("fail",k.data)}},!1),h}},b}();